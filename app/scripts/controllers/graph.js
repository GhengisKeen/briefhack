'use strict';

angular.module('briefhackApp')
   .controller('GraphCtrl', function($scope, $http) {
      Highcharts.theme = {
         colors: ["#DDDF0D", "#7798BF", "#55BF3B", "#DF5353", "#aaeeee", "#ff0066", "#eeaaee",
            "#55BF3B", "#DF5353", "#7798BF", "#aaeeee"
         ],
         chart: {
            backgroundColor: {
               linearGradient: {
                  x1: 0,
                  y1: 0,
                  x2: 0,
                  y2: 1
               },
               stops: [
                  [0, 'rgb(96, 96, 96)'],
                  [1, 'rgb(16, 16, 16)']
               ]
            },
            borderWidth: 0,
            borderRadius: 0,
            plotBackgroundColor: null,
            plotShadow: false,
            plotBorderWidth: 0
         },
         title: {
            style: {
               color: '#FFF',
               font: '16px Lucida Grande, Lucida Sans Unicode, Verdana, Arial, Helvetica, sans-serif'
            }
         },
         subtitle: {
            style: {
               color: '#DDD',
               font: '12px Lucida Grande, Lucida Sans Unicode, Verdana, Arial, Helvetica, sans-serif'
            }
         },
         xAxis: {
            gridLineWidth: 0,
            lineColor: '#999',
            tickColor: '#999',
            labels: {
               style: {
                  color: '#999',
                  fontWeight: 'bold'
               }
            },
            title: {
               style: {
                  color: '#AAA',
                  font: 'bold 12px Lucida Grande, Lucida Sans Unicode, Verdana, Arial, Helvetica, sans-serif'
               }
            }
         },
         yAxis: {
            alternateGridColor: null,
            minorTickInterval: null,
            gridLineColor: 'rgba(255, 255, 255, .1)',
            minorGridLineColor: 'rgba(255,255,255,0.07)',
            lineWidth: 0,
            tickWidth: 0,
            labels: {
               style: {
                  color: '#999',
                  fontWeight: 'bold'
               }
            },
            title: {
               style: {
                  color: '#AAA',
                  font: 'bold 12px Lucida Grande, Lucida Sans Unicode, Verdana, Arial, Helvetica, sans-serif'
               }
            }
         },
         legend: {
            itemStyle: {
               color: '#CCC'
            },
            itemHoverStyle: {
               color: '#FFF'
            },
            itemHiddenStyle: {
               color: '#333'
            }
         },
         labels: {
            style: {
               color: '#CCC'
            }
         },
         tooltip: {
            backgroundColor: {
               linearGradient: {
                  x1: 0,
                  y1: 0,
                  x2: 0,
                  y2: 1
               },
               stops: [
                  [0, 'rgba(96, 96, 96, .8)'],
                  [1, 'rgba(16, 16, 16, .8)']
               ]
            },
            borderWidth: 0,
            style: {
               color: '#FFF'
            }
         },


         plotOptions: {
            series: {
               nullColor: '#444444'
            },
            line: {
               dataLabels: {
                  color: '#CCC'
               },
               marker: {
                  lineColor: '#333'
               }
            },
            spline: {
               marker: {
                  lineColor: '#333'
               }
            },
            scatter: {
               marker: {
                  lineColor: '#333'
               }
            },
            candlestick: {
               lineColor: 'white'
            }
         },

         toolbar: {
            itemStyle: {
               color: '#CCC'
            }
         },

         navigation: {
            buttonOptions: {
               symbolStroke: '#DDDDDD',
               hoverSymbolStroke: '#FFFFFF',
               theme: {
                  fill: {
                     linearGradient: {
                        x1: 0,
                        y1: 0,
                        x2: 0,
                        y2: 1
                     },
                     stops: [
                        [0.4, '#606060'],
                        [0.6, '#333333']
                     ]
                  },
                  stroke: '#000000'
               }
            }
         },

         // scroll charts
         rangeSelector: {
            buttonTheme: {
               fill: {
                  linearGradient: {
                     x1: 0,
                     y1: 0,
                     x2: 0,
                     y2: 1
                  },
                  stops: [
                     [0.4, '#888'],
                     [0.6, '#555']
                  ]
               },
               stroke: '#000000',
               style: {
                  color: '#CCC',
                  fontWeight: 'bold'
               },
               states: {
                  hover: {
                     fill: {
                        linearGradient: {
                           x1: 0,
                           y1: 0,
                           x2: 0,
                           y2: 1
                        },
                        stops: [
                           [0.4, '#BBB'],
                           [0.6, '#888']
                        ]
                     },
                     stroke: '#000000',
                     style: {
                        color: 'white'
                     }
                  },
                  select: {
                     fill: {
                        linearGradient: {
                           x1: 0,
                           y1: 0,
                           x2: 0,
                           y2: 1
                        },
                        stops: [
                           [0.1, '#000'],
                           [0.3, '#333']
                        ]
                     },
                     stroke: '#000000',
                     style: {
                        color: 'yellow'
                     }
                  }
               }
            },
            inputStyle: {
               backgroundColor: '#333',
               color: 'silver'
            },
            labelStyle: {
               color: 'silver'
            }
         },

         navigator: {
            handles: {
               backgroundColor: '#666',
               borderColor: '#AAA'
            },
            outlineColor: '#CCC',
            maskFill: 'rgba(16, 16, 16, 0.5)',
            series: {
               color: '#7798BF',
               lineColor: '#A6C7ED'
            }
         },

         scrollbar: {
            barBackgroundColor: {
               linearGradient: {
                  x1: 0,
                  y1: 0,
                  x2: 0,
                  y2: 1
               },
               stops: [
                  [0.4, '#888'],
                  [0.6, '#555']
               ]
            },
            barBorderColor: '#CCC',
            buttonArrowColor: '#CCC',
            buttonBackgroundColor: {
               linearGradient: {
                  x1: 0,
                  y1: 0,
                  x2: 0,
                  y2: 1
               },
               stops: [
                  [0.4, '#888'],
                  [0.6, '#555']
               ]
            },
            buttonBorderColor: '#CCC',
            rifleColor: '#FFF',
            trackBackgroundColor: {
               linearGradient: {
                  x1: 0,
                  y1: 0,
                  x2: 0,
                  y2: 1
               },
               stops: [
                  [0, '#000'],
                  [1, '#333']
               ]
            },
            trackBorderColor: '#666'
         },

         // special colors for some of the demo examples
         legendBackgroundColor: 'rgba(48, 48, 48, 0.8)',
         legendBackgroundColorSolid: 'rgb(70, 70, 70)',
         dataLabelsColor: '#444',
         textColor: '#E0E0E0',
         maskColor: 'rgba(255,255,255,0.3)'
      };
      // Apply the theme
      function refresh() {

         var highchartsOptions = Highcharts.setOptions(Highcharts.theme);
         // var story_ids=['nL2N0MI1WD','nL6N0MI45Z'];
         var story_ids = $scope.currentTab.articles;
         console.log(story_ids);
         var plot_data = [];
         console.log('empty?', _.isEmpty(story_ids));
         if (_.isEmpty(story_ids)) {
            console.log('empty');
         } else {
            $scope.newsItems = [];
            plot_data[0] = [
               [1383868800000, 34.58],
               [1384128000000, 28.78],
               [1384214400000, 25.2],
               [1384300800000, 19.56],
               [1384387200000, 10.0],
               [1384473600000, 19.47],
               [1384732800000, 27.84],
               [1384819200000, 35.15],
               [1384905600000, 41.45],
               [1384992000000, 48.44],
               [1385078400000, 52.59],
               [1385337600000, 44.96],
               [1385424000000, 35.34],
               [1385510400000, 26.79],
               [1385683200000, 35.17],
               [1385942400000, 41.69],
               [1386028800000, 41.99],
               [1386115200000, 38.37],
               [1386201600000, 45.02],
               [1386288000000, 38.34],
               [1386547200000, 47.96],
               [1386633600000, 51.38],
               [1386720000000, 49.95],
               [1386806400000, 55.54],
               [1386892800000, 51.0],
               [1387152000000, 57.71],
               [1387238400000, 55.21],
               [1387324800000, 51.49],
               [1387411200000, 56.87],
               [1387497600000, 58.52],
               [1387756800000, 54.72],
               [1387843200000, 57.85],
               [1388016000000, 53.01],
               [1388102400000, 43.86],
               [1388361600000, 49.88],
               [1388448000000, 43.77],
               [1388620800000, 37.45],
               [1388707200000, 46.02],
               [1388966400000, 51.56],
               [1389052800000, 50.86],
               [1389139200000, 50.01],
               [1389225600000, 53.03],
               [1389312000000, 63.01],
               [1389571200000, 69.3],
               [1389657600000, 62.4],
               [1389744000000, 54.7],
               [1389830400000, 61.3],
               [1389916800000, 58.81],
               [1390262400000, 58.66],
               [1390348800000, 55.36],
               [1390435200000, 48.11],
               [1390521600000, 41.66],
               [1390780800000, 39.66],
               [1390867200000, 39.82],
               [1390953600000, 41.83],
               [1391040000000, 51.28],
               [1391126400000, 47.94],
               [1391385600000, 51.99],
               [1391472000000, 53.47],
               [1391558400000, 59.25],
               [1391644800000, 62.68],
               [1391731200000, 67.74],
               [1391990400000, 75.52],
               [1392076800000, 66.92],
               [1392163200000, 65.21],
               [1392249600000, 65.26],
               [1392336000000, 65.55],
               [1392681600000, 73.33],
               [1392768000000, 78.51],
               [1392854400000, 79.92],
               [1392940800000, 78.81],
               [1393200000000, 81.19],
               [1393286400000, 77.12],
               [1393372800000, 70.17],
               [1393459200000, 62.31],
               [1393545600000, 68.42],
               [1393804800000, 67.74],
               [1393891200000, 76.88],
               [1393977600000, 67.07],
               [1394064000000, 66.03],
               [1394150400000, 75.33],
               [1394409600000, 81.29],
               [1394496000000, 82.57],
               [1394582400000, 75.82],
               [1394668800000, 76.55],
               [1394755200000, 84.83],
               [1395014400000, 79.77],
               [1395100800000, 72.38],
               [1395187200000, 80.03],
               [1395273600000, 89.84],
               [1395360000000, 81.62]
            ]
            plot_data[1] = [
               [1383868800000, 12.81],
               [1384128000000, 10.0],
               [1384214400000, 16.29],
               [1384300800000, 10.83],
               [1384387200000, 14.49],
               [1384473600000, 23.66],
               [1384732800000, 32.08],
               [1384819200000, 38.85],
               [1384905600000, 39.82],
               [1384992000000, 35.87],
               [1385078400000, 33.8],
               [1385337600000, 38.68],
               [1385424000000, 40.19],
               [1385510400000, 43.61],
               [1385683200000, 50.98],
               [1385942400000, 45.33],
               [1386028800000, 53.91],
               [1386115200000, 57.69],
               [1386201600000, 64.58],
               [1386288000000, 66.87],
               [1386547200000, 75.89],
               [1386633600000, 70.63],
               [1386720000000, 80.11],
               [1386806400000, 78.98],
               [1386892800000, 72.09],
               [1387152000000, 75.43],
               [1387238400000, 78.01],
               [1387324800000, 80.19],
               [1387411200000, 79.03],
               [1387497600000, 85.42],
               [1387756800000, 78.92],
               [1387843200000, 77.97],
               [1388016000000, 78.16],
               [1388102400000, 72.18],
               [1388361600000, 76.52],
               [1388448000000, 76.73],
               [1388620800000, 67.6],
               [1388707200000, 73.15],
               [1388966400000, 68.9],
               [1389052800000, 64.12],
               [1389139200000, 69.25],
               [1389225600000, 64.03],
               [1389312000000, 69.98],
               [1389571200000, 69.24],
               [1389657600000, 73.42],
               [1389744000000, 80.22],
               [1389830400000, 72.86],
               [1389916800000, 63.28],
               [1390262400000, 59.44],
               [1390348800000, 60.29],
               [1390435200000, 58.02],
               [1390521600000, 50.93],
               [1390780800000, 45.9],
               [1390867200000, 48.6],
               [1390953600000, 40.17],
               [1391040000000, 45.42],
               [1391126400000, 44.47],
               [1391385600000, 47.28],
               [1391472000000, 57.07],
               [1391558400000, 59.72],
               [1391644800000, 67.64],
               [1391731200000, 61.71],
               [1391990400000, 67.49],
               [1392076800000, 76.6],
               [1392163200000, 67.67],
               [1392249600000, 66.86],
               [1392336000000, 57.01],
               [1392681600000, 55.55],
               [1392768000000, 47.18],
               [1392854400000, 41.89],
               [1392940800000, 48.85],
               [1393200000000, 47.77],
               [1393286400000, 38.63],
               [1393372800000, 29.9],
               [1393459200000, 23.62],
               [1393545600000, 22.2],
               [1393804800000, 22.62],
               [1393891200000, 29.5],
               [1393977600000, 24.93],
               [1394064000000, 29.39],
               [1394150400000, 27.6],
               [1394409600000, 33.56],
               [1394496000000, 41.75],
               [1394582400000, 49.83],
               [1394668800000, 58.7],
               [1394755200000, 66.99],
               [1395014400000, 67.04],
               [1395100800000, 73.92],
               [1395187200000, 76.44],
               [1395273600000, 74.37],
               [1395360000000, 74.76]
            ]
            plot_data[2] = [
               [1383868800000, 45.76],
               [1384128000000, 38.17],
               [1384214400000, 37.74],
               [1384300800000, 39.26],
               [1384387200000, 43.49],
               [1384473600000, 39.44],
               [1384732800000, 47.01],
               [1384819200000, 51.37],
               [1384905600000, 49.46],
               [1384992000000, 49.01],
               [1385078400000, 52.35],
               [1385337600000, 43.38],
               [1385424000000, 48.66],
               [1385510400000, 55.59],
               [1385683200000, 63.6],
               [1385942400000, 69.15],
               [1386028800000, 68.59],
               [1386115200000, 67.81],
               [1386201600000, 71.28],
               [1386288000000, 66.55],
               [1386547200000, 58.94],
               [1386633600000, 60.24],
               [1386720000000, 52.18],
               [1386806400000, 61.95],
               [1386892800000, 65.87],
               [1387152000000, 74.22],
               [1387238400000, 82.79],
               [1387324800000, 88.23],
               [1387411200000, 85.68],
               [1387497600000, 88.27],
               [1387756800000, 90.83],
               [1387843200000, 96.9],
               [1388016000000, 88.41],
               [1388102400000, 86.49],
               [1388361600000, 82.1],
               [1388448000000, 83.74],
               [1388620800000, 90.2],
               [1388707200000, 81.33],
               [1388966400000, 77.76],
               [1389052800000, 68.54],
               [1389139200000, 60.74],
               [1389225600000, 56.92],
               [1389312000000, 62.09],
               [1389571200000, 58.26],
               [1389657600000, 53.64],
               [1389744000000, 49.36],
               [1389830400000, 52.09],
               [1389916800000, 54.12],
               [1390262400000, 58.3],
               [1390348800000, 60.58],
               [1390435200000, 51.01],
               [1390521600000, 60.63],
               [1390780800000, 69.42],
               [1390867200000, 69.56],
               [1390953600000, 63.52],
               [1391040000000, 70.51],
               [1391126400000, 60.76],
               [1391385600000, 57.08],
               [1391472000000, 49.85],
               [1391558400000, 41.08],
               [1391644800000, 33.7],
               [1391731200000, 30.87],
               [1391990400000, 24.42],
               [1392076800000, 19.32],
               [1392163200000, 15.32],
               [1392249600000, 19.58],
               [1392336000000, 24.05],
               [1392681600000, 28.41],
               [1392768000000, 25.31],
               [1392854400000, 28.79],
               [1392940800000, 25.15],
               [1393200000000, 34.67],
               [1393286400000, 40.25],
               [1393372800000, 34.08],
               [1393459200000, 24.31],
               [1393545600000, 15.81],
               [1393804800000, 25.25],
               [1393891200000, 30.02],
               [1393977600000, 22.63],
               [1394064000000, 19.58],
               [1394150400000, 19.23],
               [1394409600000, 10.0],
               [1394496000000, 16.46],
               [1394582400000, 13.22],
               [1394668800000, 15.26],
               [1394755200000, 18.25],
               [1395014400000, 19.06],
               [1395100800000, 18.88],
               [1395187200000, 19.96],
               [1395273600000, 14.85],
               [1395360000000, 13.96]
            ]
            plot_data[3] = [
               [1383868800000, 79.97],
               [1384128000000, 80.69],
               [1384214400000, 81.92],
               [1384300800000, 77.13],
               [1384387200000, 77.29],
               [1384473600000, 73.45],
               [1384732800000, 80.13],
               [1384819200000, 75.05],
               [1384905600000, 74.8],
               [1384992000000, 72.39],
               [1385078400000, 71.2],
               [1385337600000, 76.3],
               [1385424000000, 76.91],
               [1385510400000, 82.14],
               [1385683200000, 78.14],
               [1385942400000, 78.76],
               [1386028800000, 72.51],
               [1386115200000, 63.0],
               [1386201600000, 58.73],
               [1386288000000, 62.44],
               [1386547200000, 62.13],
               [1386633600000, 65.34],
               [1386720000000, 58.17],
               [1386806400000, 59.2],
               [1386892800000, 63.49],
               [1387152000000, 68.57],
               [1387238400000, 75.19],
               [1387324800000, 72.71],
               [1387411200000, 72.3],
               [1387497600000, 72.34],
               [1387756800000, 65.21],
               [1387843200000, 68.44],
               [1388016000000, 62.2],
               [1388102400000, 62.92],
               [1388361600000, 65.55],
               [1388448000000, 73.38],
               [1388620800000, 70.49],
               [1388707200000, 67.57],
               [1388966400000, 74.94],
               [1389052800000, 82.88],
               [1389139200000, 81.63],
               [1389225600000, 80.39],
               [1389312000000, 71.56],
               [1389571200000, 76.16],
               [1389657600000, 74.44],
               [1389744000000, 65.45],
               [1389830400000, 68.42],
               [1389916800000, 59.14],
               [1390262400000, 60.02],
               [1390348800000, 51.54],
               [1390435200000, 52.83],
               [1390521600000, 56.91],
               [1390780800000, 52.97],
               [1390867200000, 47.77],
               [1390953600000, 46.85],
               [1391040000000, 47.31],
               [1391126400000, 53.14],
               [1391385600000, 50.39],
               [1391472000000, 45.09],
               [1391558400000, 49.3],
               [1391644800000, 57.04],
               [1391731200000, 49.66],
               [1391990400000, 43.95],
               [1392076800000, 38.16],
               [1392163200000, 44.17],
               [1392249600000, 40.86],
               [1392336000000, 50.31],
               [1392681600000, 58.42],
               [1392768000000, 51.05],
               [1392854400000, 44.4],
               [1392940800000, 48.57],
               [1393200000000, 42.36],
               [1393286400000, 42.19],
               [1393372800000, 43.42],
               [1393459200000, 33.99],
               [1393545600000, 37.74],
               [1393804800000, 27.92],
               [1393891200000, 20.15],
               [1393977600000, 16.55],
               [1394064000000, 21.11],
               [1394150400000, 26.53],
               [1394409600000, 27.9],
               [1394496000000, 24.64],
               [1394582400000, 23.88],
               [1394668800000, 16.1],
               [1394755200000, 16.44],
               [1395014400000, 16.26],
               [1395100800000, 18.64],
               [1395187200000, 21.68],
               [1395273600000, 11.7],
               [1395360000000, 10.0]
            ]
            plot_data[4] = [
               [1383868800000, 41.27],
               [1384128000000, 31.31],
               [1384214400000, 28.83],
               [1384300800000, 29.63],
               [1384387200000, 26.72],
               [1384473600000, 26.45],
               [1384732800000, 28.04],
               [1384819200000, 26.52],
               [1384905600000, 29.07],
               [1384992000000, 34.05],
               [1385078400000, 34.36],
               [1385337600000, 26.75],
               [1385424000000, 29.41],
               [1385510400000, 34.89],
               [1385683200000, 28.1],
               [1385942400000, 30.95],
               [1386028800000, 24.76],
               [1386115200000, 32.91],
               [1386201600000, 31.22],
               [1386288000000, 38.28],
               [1386547200000, 41.95],
               [1386633600000, 33.03],
               [1386720000000, 42.37],
               [1386806400000, 52.11],
               [1386892800000, 44.88],
               [1387152000000, 38.03],
               [1387238400000, 32.33],
               [1387324800000, 33.83],
               [1387411200000, 25.46],
               [1387497600000, 34.05],
               [1387756800000, 26.7],
               [1387843200000, 17.43],
               [1388016000000, 10.0],
               [1388102400000, 10.6],
               [1388361600000, 12.69],
               [1388448000000, 14.72],
               [1388620800000, 21.94],
               [1388707200000, 26.31],
               [1388966400000, 28.01],
               [1389052800000, 32.78],
               [1389139200000, 26.04],
               [1389225600000, 30.75],
               [1389312000000, 40.63],
               [1389571200000, 49.37],
               [1389657600000, 58.73],
               [1389744000000, 57.34],
               [1389830400000, 60.65],
               [1389916800000, 64.79],
               [1390262400000, 74.43],
               [1390348800000, 69.8],
               [1390435200000, 71.13],
               [1390521600000, 70.12],
               [1390780800000, 72.05],
               [1390867200000, 75.91],
               [1390953600000, 74.77],
               [1391040000000, 65.87],
               [1391126400000, 67.36],
               [1391385600000, 76.01],
               [1391472000000, 80.88],
               [1391558400000, 81.1],
               [1391644800000, 87.48],
               [1391731200000, 84.01],
               [1391990400000, 83.74],
               [1392076800000, 85.44],
               [1392163200000, 89.96],
               [1392249600000, 99.51],
               [1392336000000, 104.96],
               [1392681600000, 98.04],
               [1392768000000, 94.72],
               [1392854400000, 99.87],
               [1392940800000, 99.75],
               [1393200000000, 101.57],
               [1393286400000, 111.46],
               [1393372800000, 115.33],
               [1393459200000, 112.3],
               [1393545600000, 112.33],
               [1393804800000, 116.69],
               [1393891200000, 125.3],
               [1393977600000, 134.58],
               [1394064000000, 129.46],
               [1394150400000, 121.49],
               [1394409600000, 121.18],
               [1394496000000, 119.78],
               [1394582400000, 128.89],
               [1394668800000, 122.85],
               [1394755200000, 115.71],
               [1395014400000, 117.34],
               [1395100800000, 118.52],
               [1395187200000, 124.39],
               [1395273600000, 123.51],
               [1395360000000, 115.09]
            ]
            var plot_series = [];
            var counter = 0;
            for (var i = 0; i < story_ids.length; i++) {
               $http.get('/api/Reuters/NewsArticlesDetails/' + encodeURIComponent(JSON.stringify({
                  '$filter': "Request/StoryId eq '" + story_ids[i] + "' ",
               }))).
               success(function(data) {
                  plot_series.push({
                     name: data.d[0].PrimaryRics.split(' ')[0],
                     data: plot_data[counter],
                     tooltip: {
                        valueDecimals: 2
                     }
                  });
                  counter++;
                  if (counter == story_ids.length) {
                     drawGraph(plot_series);
                  }
                  console.log(data.d[0].StoryText);
                  $scope.newsItems.push({
                     name: data.d[0].Id,
                     headline: data.d[0].Headline
                        .replace(/<([^>]*)>/g, '(<a href="#">$1</a>)')
                        .replace(/\[([^\]]*)\]/g, '(<a href="#">$1</a>)'),
                     text: data.d[0].StoryText
                        .replace(/<([^>]*)>/g, '(<a href="#">$1</a>)')
                        .replace(/\[([^\]]*)\]/g, '(<a href="#">$1</a>)')
                        .replace(/\n(\t|  +|\n)/g,"<br />\t")
                        .replace(/\n/g," ")
                  });
               });
            }
         }
      }


      function drawGraph(plot_series) {
         $('#container').highcharts('StockChart', {
            rangeSelector: {
               selected: 2,
               inputEnabled: $('#container').width() > 480
            },

            title: {
               text: 'Stock Prices'
            },
            yAxis: {
               labels: {
                  formatter: function() {
                     return (this.value > 0 ? '+' : '') + this.value + '%';
                  }
               },
               plotLines: [{
                  value: 0,
                  width: 2,
                  color: 'silver'
               }]
            },

            plotOptions: {
               series: {
                  compare: 'percent'
               }
            },

            series: plot_series
         });
      }

      $scope.$watch('currentTab', function(newValue, oldValue) {
         console.log("on change", newValue, oldValue);
         refresh();
         // $scope.count++;
      });
   });